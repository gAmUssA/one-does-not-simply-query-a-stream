# ðŸŒŠ RisingWave with Confluent Cloud Integration
# GNU Make 4.0+ required for .RECIPEPREFIX support
ifeq ($(origin .RECIPEPREFIX), undefined)
$(error This Make does not support .RECIPEPREFIX. Please use GNU Make 4.0 or later)
endif

# Makefile Preamble - Davis-Hansson Best Practices
SHELL := bash
.ONESHELL:
.SHELLFLAGS := -eu -o pipefail -c
.DELETE_ON_ERROR:
MAKEFLAGS += --warn-undefined-variables
MAKEFLAGS += --no-builtin-rules
.RECIPEPREFIX = >

# ANSI color codes
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
RED := \033[0;31m
NC := \033[0m

# Default target
.DEFAULT_GOAL := help

.PHONY: help start create info destroy run-client status check-env

help: ## ðŸ“š Show this help message
> @printf "$(BLUE)ðŸŒŠ RisingWave with Confluent Cloud$(NC)\n"
> @printf "$(YELLOW)Available targets:$(NC)\n"
> @awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

check-env: ## ðŸ” Check if .env file exists and has required variables
> @if [ ! -f "../.env" ]; then \
>   printf "$(RED)âŒ .env file not found in parent directory$(NC)\n"; \
>   printf "$(YELLOW)ðŸ’¡ Copy .env.example to .env and configure your Confluent Cloud settings$(NC)\n"; \
>   exit 1; \
> fi
> @printf "$(GREEN)âœ… .env file found$(NC)\n"
> @if ! grep -q "BOOTSTRAP_SERVERS" ../.env; then \
>   printf "$(RED)âŒ BOOTSTRAP_SERVERS not found in .env$(NC)\n"; \
>   exit 1; \
> fi
> @printf "$(GREEN)âœ… Confluent Cloud configuration detected$(NC)\n"

start: check-env ## ðŸš€ Start RisingWave with Confluent Cloud connection
> @printf "$(BLUE)ðŸŒŠ Starting RisingWave with Confluent Cloud integration...$(NC)\n"
> docker compose up -d
> @printf "$(YELLOW)â³ Waiting for RisingWave to be ready...$(NC)\n"
> @while ! nc -z localhost 4566; do \
>   sleep 1; \
>   printf "."; \
> done
> @printf "\n$(GREEN)âœ… ðŸŒŠ RisingWave is ready!$(NC)\n"

create: start ## ðŸ—ï¸ Alias for start (backward compatibility)

info: ## ðŸ“Š Show connection information
> @printf "\n$(BLUE)===========================================================$(NC)\n"
> @printf "$(GREEN)ðŸŒŠ RisingWave Connection Info:$(NC)\n"
> @printf "$(BLUE)===========================================================$(NC)\n"
> @printf "ðŸ”— RisingWave Frontend: $(YELLOW)localhost:4566$(NC)\n"
> @printf "ðŸ“Š RisingWave Metrics:  $(YELLOW)localhost:5691$(NC)\n"
> @printf "â˜ï¸  Confluent Cloud:     $(YELLOW)Connected via .env$(NC)\n"
> @printf "$(BLUE)===========================================================$(NC)\n"
> @printf "$(GREEN)ðŸ’¡ Connect with: docker compose exec -it psql-client psql -h risingwave -p 4566 -d dev -U root$(NC)\n"
> @printf "$(BLUE)===========================================================$(NC)\n"

status: ## ðŸ“ˆ Check RisingWave status
> @printf "$(BLUE)ðŸ“Š RisingWave Status:$(NC)\n"
> @if docker compose ps risingwave | grep -q "Up"; then \
>   printf "$(GREEN)âœ… RisingWave is running$(NC)\n"; \
> else \
>   printf "$(RED)âŒ RisingWave is not running$(NC)\n"; \
> fi
> @if nc -z localhost 4566; then \
>   printf "$(GREEN)âœ… RisingWave frontend is accessible$(NC)\n"; \
> else \
>   printf "$(RED)âŒ RisingWave frontend is not accessible$(NC)\n"; \
> fi

destroy: ## ðŸ§¹ Stop and remove all containers
> @printf "$(RED)ðŸ§¹ Stopping and removing RisingWave containers...$(NC)\n"
> docker compose down -v
> @printf "$(GREEN)âœ… Cleanup complete$(NC)\n"

run-client: ## ðŸ”Œ Connect to RisingWave using psql client
> @printf "$(BLUE)ðŸ”Œ Connecting to RisingWave...$(NC)\n"
> docker compose exec -it psql-client psql -h risingwave -p 4566 -d dev -U root

logs: ## ðŸ“ Show RisingWave logs
> @printf "$(BLUE)ðŸ“ RisingWave logs:$(NC)\n"
> docker compose logs -f risingwave